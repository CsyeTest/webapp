# Deployment Guide: DigitalOcean

## 1. Access Your Droplet via SSH

- Use the SSH command to connect to your droplet. Replace `your_droplet_ip` with the IP address of your droplet:

  ```
  ssh root@your_droplet_ip
  ```

- Ensure that the SSH key generated by `ssh-keygen` is configured in DigitalOcean.

## 2. Update Your Droplet (First Time Activity Mostly)

```
sudo dnf update -y
```

## 3. Install Node.js

### 1. Import NodeSource Repository

- Download and execute the NodeSource installation script for Node.js v20.x:

  ```
  curl -sL https://rpm.nodesource.com/setup_20.x | sudo bash -
  ```

### 2. Install Node.js

- Install Node.js with `dnf`:

  ```
  sudo dnf install -y nodejs
  ```

### 3. Verify Installation

- Verify that Node.js and npm are correctly installed:

  ```
  node -v
  npm -v
  ```

## 4. Install PostgreSQL

Install PostgreSQL on your droplet:

```
sudo dnf install -y postgresql-server postgresql-contrib
```

Initialize the database and enable it to start on boot:

```
sudo postgresql-setup --initdb
sudo systemctl start postgresql
sudo systemctl enable postgresql
```

## 5. Configure PostgreSQL

- Switch to the `postgres` user and create a new database and user for your application:

  ```
  sudo -i -u postgres
  createdb cloud_db
  psql -d cloud_db
  CREATE ROLE cloud_admin WITH LOGIN PASSWORD 'password';
  GRANT ALL PRIVILEGES ON DATABASE cloud_db TO cloud_admin;
  vi /var/lib/pgsql/data/pg_hba.conf
  ```

- In `pg_hba.conf`, set IPv4 and IPv6 local connection method to `md5`:

  ```plaintext
  host    all             all             127.0.0.1/32            md5
  host    all             all             ::1/128                 md5
  ```

- Restart PostgreSQL after making changes:

  ```
  systemctl restart postgresql
  ```

## 6. Transfer Your Web App to the Droplet

- Use `scp` to transfer your application files to the droplet:

  ```
  scp -r webapp-main.zip root@your_droplet_ip:/home
  ```

- Unzip the file:

  ```
  sudo dnf install zip
  unzip webapp-main.zip
  ```

## 7. Install Your App Dependencies

SSH back into your droplet, navigate to your app's directory, and install dependencies:

```
cd /home/webapp
npm install
```

## 8. Configure Environment Variables

Configure the `.env` file:

```
cat .env.example > .env
vi .env
```

## 9. Start Your Application

- Start the server using the following command:

  ```
  node server.js
  ```

## 10. Hit API Requests

- Test API requests:

  ```
  curl -vvvv http://localhost:8080/healthz
  ```

  ```
  curl -X POST \
    http://localhost:8080/v1/user \
    -H 'Content-Type: application/json' \
    -d '{
      "first_name": "nitesh",
      "last_name": "more",
      "password": "nitesh123",
      "username": "nitesh@email.com"
    }'
  ```

- To get the encoded value for the header:

  ```
  echo -n 'username:password' | base64
  ```

  ```
  curl -X GET \
    http://localhost:8080/v1/user \
    -H 'Authorization: Basic bml0ZXNoQGVtYWlsLmNvbTpuaXRlc2gxMjM='
  ```

## If using sh script:
1. scp -r deployement.sh root@IP:/home
2. scp -r web-app.zip root@IP:/home
    -After copy execute below:
3. chmod 755 deployement.sh
4. ./dedeployement.sh db_user_name db_user_password
   -After execution run below:
5. vi .env
6. vi /var/lib/pgsql/data/pg_hba.conf
7. systemctl restart postgresql
   
